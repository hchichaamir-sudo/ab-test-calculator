<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pandora A/B Calculator (CL + Power + Revenue)</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#ebe7e7;
      --muted:#6b6b6b;
      --text:#111111;
      --shadow: 0 10px 28px rgba(0,0,0,.06);
      --shadow2: 0 6px 16px rgba(0,0,0,.05);
      --radius:18px;

      --wait:#b24a4a; /* muted red for empty state text */
      --hi-red:#e34d5b;
      --hi-blue:#2f6fe8;

      --cta-hover:#FF93A0;
      --ok:#1f8f4a;
      --bad:#d64545;
    }

    *{box-sizing:border-box;}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(0,0,0,.04), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(0,0,0,.03), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .container{
      max-width:1180px;
      margin:24px auto;
      padding:0 18px 60px;
    }

    /* Header row */
    .header-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      padding:14px 18px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
      position: sticky;
      top: 14px;
      z-index: 5;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title-wrap{
      display:flex;
      align-items:flex-start;
      gap:6px;
    }
    .title{
      margin:0;
      font-size:24px;
      font-weight:900;
      letter-spacing:-.4px;
      line-height:1.1;
    }
    .sup{
      font-size:11px;
      font-weight:800;
      transform: translateY(2px);
      opacity:.9;
    }
    .subtitle{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .header-right{
      display:flex;
      align-items:flex-start;
      justify-content:flex-end;
      min-width:140px;
    }
    /* 2) Header cleanup: only PANDORA (no dots) */
    .pandora-logo{
      height:22px;
      width:auto;
      display:block;
      margin-top:4px;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      margin-top:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      .header-right{min-width:auto;}
    }

    /* Cards */
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .card h3{
      margin:0 0 12px;
      font-size:15px;
      letter-spacing:.2px;
      font-weight:900;
    }

    label{
      display:block;
      font-size:12px;
      margin:12px 0 6px;
      color:#2b2b2b;
      font-weight:700;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      font-size:14px;
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus{
      border-color:#cfcaca;
      box-shadow: 0 0 0 4px rgba(0,0,0,.06);
    }
    input::placeholder{ color:#b9b2b2; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 560px){
      .row{grid-template-columns:1fr;}
    }

    /* 3) CTA styles */
    .btn{
      margin-top:16px;
      padding:12px 14px;
      border:1px solid #111;
      border-radius: 14px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-weight:800;
      font-size:14px;
      transition: background-color .25s ease, color .25s ease;
      /* no layout shift: keep border same */
    }
    .btn:hover{
      background: var(--cta-hover);
      color:#111;
    }

    /* KPIs */
    .out{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:12px;
    }
    .kpi{
      background: #fbfbfb;
      border:1px solid var(--border);
      border-radius: 16px;
      padding:14px;
      box-shadow: 0 6px 14px rgba(0,0,0,.03);
      min-height:70px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi b{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:900;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .kpi span{
      font-size:18px;
      font-weight:900;
      letter-spacing:-.2px;
    }

    /* Empty state */
    .waiting{
      font-size:12px !important;
      font-style: italic;
      font-weight:700;
      color: var(--wait);
      letter-spacing: 0;
    }

    /* Highlight borders (thin, no layout shift) */
    .kpi.red-highlight{ outline: 1px solid var(--hi-red); outline-offset: 0; }
    .kpi.blue-highlight{ outline: 1px solid var(--hi-blue); outline-offset: 0; }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:14px;
      line-height:1.55;
      padding-top:12px;
      border-top:1px dashed #eee;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    .watermark{
      position: fixed;
      right: 16px;
      bottom: 12px;
      font-size:12px;
      color: rgba(0,0,0,.35);
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.08);
      padding: 6px 10px;
      border-radius: 999px;
      backdrop-filter: blur(8px);
      user-select:none;
    }

    /* 5) Decision styling */
    .decision-good{ color: var(--ok) !important; }
    .decision-bad{ color: var(--bad) !important; }
  </style>
</head>

<body>
  <div class="container">

    <div class="header-row">
      <div class="header-left">
        <div class="title-wrap">
          <h1 class="title">A/B Test Calculator</h1>
          <span class="sup">AH</span>
        </div>
        <p class="subtitle">CL • Power • Revenue — internal helper</p>
      </div>

      <div class="header-right">
        <!-- Clean: only PANDORA -->
        <svg class="pandora-logo" viewBox="0 0 190 34" xmlns="http://www.w3.org/2000/svg" aria-label="Pandora">
          <text x="0" y="25" font-family="Arial, sans-serif" font-size="26" font-weight="800" fill="#111">PANDORA</text>
        </svg>
      </div>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <h3>Inputs</h3>

        <div class="row">
          <div>
            <label>Input mode</label>
            <select id="inputMode" onchange="toggleMode()">
              <option value="conv">Visitors + Conversions</option>
              <option value="cvr" selected>Visitors + CVR</option>
            </select>
          </div>
          <div>
            <label>CVR format (if CVR mode)</label>
            <select id="cvrFormat" onchange="calc()">
              <option value="pct" selected>Percent (e.g. 2.12)</option>
              <option value="dec">Decimal (e.g. 0.0212)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Visitors A (nA)</label>
            <input id="nA" type="number" min="1" value="" placeholder="Enter data" />
          </div>
          <div>
            <label>Visitors B (nB)</label>
            <input id="nB" type="number" min="1" value="" placeholder="Enter data" />
          </div>
        </div>

        <div id="convMode" style="display:none;">
          <div class="row">
            <div>
              <label>Conversions A (xA)</label>
              <input id="xA" type="number" min="0" value="" placeholder="Enter data" />
            </div>
            <div>
              <label>Conversions B (xB)</label>
              <input id="xB" type="number" min="0" value="" placeholder="Enter data" />
            </div>
          </div>
        </div>

        <div id="cvrMode">
          <div class="row">
            <div>
              <label>CVR A</label>
              <input id="cvrA" type="text" value="" placeholder="Enter data" />
            </div>
            <div>
              <label>CVR B</label>
              <input id="cvrB" type="text" value="" placeholder="Enter data" />
            </div>
          </div>
          <div class="note">
            In CVR mode we approximate conversions as: <span class="mono">x = round(CVR × visitors)</span>.
          </div>
        </div>

        <div class="row">
          <div>
            <label>Hypothesis</label>
            <select id="hypo" onchange="calc()">
              <option value="two" selected>Two-sided</option>
              <option value="one">One-sided (B &gt; A)</option>
            </select>
          </div>
          <div>
            <label>Confidence</label>
            <select id="conf" onchange="calc()">
              <option value="0.90">90%</option>
              <option value="0.95" selected>95%</option>
              <option value="0.99">99%</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Market</label>
            <select id="market" onchange="setCurrencyFromMarket(); calc();">
              <option value="UK">UK</option>
              <option value="IE">IE</option>
              <option value="FR" selected>FR</option>
              <option value="ES">ES</option>
              <option value="PT">PT</option>
              <option value="DE">DE</option>
              <option value="AT">AT</option>
              <option value="CH">CH</option>
              <option value="BE">BE</option>
              <option value="NL">NL</option>
              <option value="DK">DK</option>
              <option value="NO">NO</option>
              <option value="SE">SE</option>
              <option value="IT">IT</option>
              <option value="TR">TR</option>
              <option value="GR">GR</option>
              <option value="PL">PL</option>
              <option value="CZ">CZ</option>
              <option value="SK">SK</option>
              <option value="HU">HU</option>
              <option value="RO">RO</option>
              <option value="US">US</option>
              <option value="CA">CA</option>
              <option value="AU">AU</option>
              <option value="NZ">NZ</option>
              <option value="JP">JP</option>
              <option value="SG">SG</option>
              <option value="HK">HK</option>
            </select>
          </div>
          <div>
            <label>Currency</label>
            <select id="currency" onchange="calc()">
              <option value="EUR" selected>EUR</option>
              <option value="DKK">DKK</option>
              <option value="GBP">GBP</option>
              <option value="CHF">CHF</option>
              <option value="NOK">NOK</option>
              <option value="SEK">SEK</option>
              <option value="PLN">PLN</option>
              <option value="CZK">CZK</option>
              <option value="HUF">HUF</option>
              <option value="RON">RON</option>
              <option value="TRY">TRY</option>
              <option value="USD">USD</option>
              <option value="CAD">CAD</option>
              <option value="AUD">AUD</option>
              <option value="NZD">NZD</option>
              <option value="JPY">JPY</option>
              <option value="SGD">SGD</option>
              <option value="HKD">HKD</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>RPS CTRL</label>
            <input id="rpsA" type="text" value="" placeholder="Enter data" />
          </div>
          <div>
            <label>RPS VAR</label>
            <input id="rpsB" type="text" value="" placeholder="Enter data" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Last-year traffic (sessions on that page)</label>
            <input id="lastYearSessions" type="number" min="0" value="" placeholder="Enter data" />
          </div>
          <div>
            <label>Note</label>
            <input type="text" value="Approx only (directional)" readonly />
          </div>
        </div>

        <button class="btn" onclick="calc()">Calculate</button>

        <div class="note">
          Revenue estimate:
          <span class="mono">(RPS_VAR - RPS_CTRL) × Sessions_VAR</span> (Sessions_VAR = Visitors B).<br/>
          Last-year potential:
          <span class="mono">(RPS_VAR - RPS_CTRL) × Last-year traffic</span> → approximate only.
        </div>
      </div>

      <!-- RESULTS -->
      <div class="card">
        <h3>Results</h3>

        <div class="out">
          <div class="kpi"><b>CR A</b><span id="crA"></span></div>
          <div class="kpi"><b>CR B</b><span id="crB"></span></div>

          <div class="kpi"><b>Relative uplift</b><span id="uplift"></span></div>
          <div class="kpi"><b>Absolute diff (pp)</b><span id="diffpp"></span></div>

          <div class="kpi"><b>SE A</b><span id="seA"></span></div>
          <div class="kpi"><b>SE B</b><span id="seB"></span></div>

          <div class="kpi"><b>SE difference</b><span id="seDiff"></span></div>
          <div class="kpi"><b>z-score</b><span id="z"></span></div>

          <!-- 4) Swap positions: OBSERVED POWER now before P-VALUE -->
          <div class="kpi red-highlight"><b>Observed Power</b><span id="power"></span></div>
          <div class="kpi"><b>p-value</b><span id="p"></span></div>

          <div class="kpi red-highlight"><b>CL (1 - P)</b><span id="cl"></span></div>
          <div class="kpi"><b>Decision @ conf</b><span id="sig"></span></div>

          <div class="kpi"><b>Currency</b><span id="curOut"></span></div>
          <div class="kpi"><b>RPS diff (VAR - CTRL)</b><span id="rpsDiff"></span></div>

          <div class="kpi blue-highlight"><b>Estimated Revenue (Test Period)</b><span id="estRev"></span></div>
          <div class="kpi blue-highlight"><b>Last-year Potential (Approx)</b><span id="lastYearRev"></span></div>
        </div>
      </div>
    </div>

    <div class="watermark">By EXP-LAB</div>
  </div>

<script>
/* ===== Helpers ===== */
function parseLocaleNumber(v){
  if (v === null || v === undefined) return NaN;
  const s = String(v).trim().replace(/\s+/g,'').replace(',', '.');
  if (s === '') return NaN;
  return Number(s);
}

function erf(x){
  const sign = x >= 0 ? 1 : -1;
  x = Math.abs(x);
  const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429;
  const p=0.3275911;
  const t = 1/(1+p*x);
  const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
  return sign*y;
}
function normCdf(z){ return 0.5*(1+erf(z/Math.SQRT2)); }

// Inverse Normal CDF (Acklam)
function normInv(p){
  if (p <= 0 || p >= 1) return NaN;
  const a = [-3.969683028665376e+01,  2.209460984245205e+02, -2.759285104469687e+02,
              1.383577518672690e+02, -3.066479806614716e+01,  2.506628277459239e+00];
  const b = [-5.447609879822406e+01,  1.615858368580409e+02, -1.556989798598866e+02,
              6.680131188771972e+01, -1.328068155288572e+01];
  const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00,
             -2.549732539343734e+00,  4.374664141464968e+00,  2.938163982698783e+00];
  const d = [ 7.784695709041462e-03,  3.224671290700398e-01,  2.445134137142996e+00,
              3.754408661907416e+00];
  const plow = 0.02425;
  const phigh = 1 - plow;
  let q, r;

  if (p < plow){
    q = Math.sqrt(-2*Math.log(p));
    return (((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]) /
           ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
  }
  if (p > phigh){
    q = Math.sqrt(-2*Math.log(1-p));
    return -(((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]) /
            ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
  }
  q = p - 0.5;
  r = q*q;
  return (((((a[0]*r + a[1])*r + a[2])*r + a[3])*r + a[4])*r + a[5]) * q /
         (((((b[0]*r + b[1])*r + b[2])*r + b[3])*r + b[4])*r + 1);
}

function fmtPct(x, d=2){ return (x*100).toFixed(d) + "%"; }
function fmtNum(x, d=4){ return Number.isFinite(x) ? x.toFixed(d) : "—"; }
function fmtMoney(x){
  if (!Number.isFinite(x)) return "—";
  return x.toLocaleString(undefined, { maximumFractionDigits: 0 });
}

/* ===== Market -> Currency ===== */
const marketCurrency = {
  UK:"GBP", IE:"EUR", FR:"EUR", ES:"EUR", PT:"EUR", DE:"EUR", AT:"EUR", CH:"CHF", BE:"EUR", NL:"EUR",
  DK:"DKK", NO:"NOK", SE:"SEK", IT:"EUR", TR:"TRY", GR:"EUR", PL:"PLN", CZ:"CZK", SK:"EUR", HU:"HUF",
  RO:"RON", US:"USD", CA:"CAD", AU:"AUD", NZ:"NZD", JP:"JPY", SG:"SGD", HK:"HKD"
};

function setCurrencyFromMarket(){
  const m = document.getElementById("market").value;
  const cur = marketCurrency[m] || "EUR";
  document.getElementById("currency").value = cur;
}

function toggleMode(){
  const mode = document.getElementById("inputMode").value;
  document.getElementById("convMode").style.display = (mode === "conv") ? "block" : "none";
  document.getElementById("cvrMode").style.display  = (mode === "cvr") ? "block" : "none";
  clearResultsIfEmpty();
}

/* ===== Empty state ===== */
const RESULT_IDS = ["crA","crB","uplift","diffpp","seA","seB","seDiff","z","p","cl","power","sig","curOut","rpsDiff","estRev","lastYearRev"];

function setWaiting(id){
  const el = document.getElementById(id);
  el.textContent = "Waiting for input";
  el.classList.add("waiting");
}
function setAllWaiting(){
  RESULT_IDS.forEach(setWaiting);
  // currency can always display even without calc
  const curOut = document.getElementById("curOut");
  curOut.textContent = document.getElementById("currency").value;
  curOut.classList.remove("waiting");
}

function anyInputProvided(){
  const mode = document.getElementById("inputMode").value;
  const nA = Number(document.getElementById("nA").value);
  const nB = Number(document.getElementById("nB").value);
  if (!(nA>0 && nB>0)) return false;

  if (mode === "conv"){
    const xA = Number(document.getElementById("xA").value);
    const xB = Number(document.getElementById("xB").value);
    return Number.isFinite(xA) && Number.isFinite(xB);
  } else {
    const a = parseLocaleNumber(document.getElementById("cvrA").value);
    const b = parseLocaleNumber(document.getElementById("cvrB").value);
    return Number.isFinite(a) && Number.isFinite(b);
  }
}

function clearResultsIfEmpty(){
  if (!anyInputProvided()){
    setAllWaiting();
  } else {
    calc();
  }
}

/* ===== Main calc (EQUATIONS UNCHANGED) ===== */
function calc(){
  if (!anyInputProvided()){
    setAllWaiting();
    return;
  }

  const mode = document.getElementById("inputMode").value;

  const nA = Number(document.getElementById("nA").value);
  const nB = Number(document.getElementById("nB").value);

  let xA, xB;
  if (mode === "conv"){
    xA = Number(document.getElementById("xA").value);
    xB = Number(document.getElementById("xB").value);
  } else {
    const cvrFmt = document.getElementById("cvrFormat").value;
    const rawA = parseLocaleNumber(document.getElementById("cvrA").value);
    const rawB = parseLocaleNumber(document.getElementById("cvrB").value);

    const pA = (cvrFmt === "pct") ? rawA/100 : rawA;
    const pB = (cvrFmt === "pct") ? rawB/100 : rawB;

    xA = Math.round(pA * nA);
    xB = Math.round(pB * nB);
  }

  if (xA<0 || xB<0 || xA>nA || xB>nB){
    setAllWaiting();
    return;
  }

  const hypo = document.getElementById("hypo").value;
  const conf = Number(document.getElementById("conf").value);
  const alpha = 1 - conf;

  const pA = xA/nA;
  const pB = xB/nB;
  const delta = pB - pA;

  const seA = Math.sqrt(pA*(1-pA)/nA);
  const seB = Math.sqrt(pB*(1-pB)/nB);
  const seDiff = Math.sqrt(seA*seA + seB*seB);

  const z = delta / seDiff;

  let pValue;
  if (hypo === "two"){
    pValue = 2*(1 - normCdf(Math.abs(z)));
  } else {
    pValue = 1 - normCdf(z);
  }

  const CL = (1 - pValue);
  const zCrit = (hypo === "two") ? normInv(1 - alpha/2) : normInv(1 - alpha);

  const mu = z;
  let power;
  if (hypo === "two"){
    power = (1 - normCdf(zCrit - mu)) + normCdf(-zCrit - mu);
  } else {
    power = (1 - normCdf(zCrit - mu));
  }

  // Revenue (UNCHANGED)
  const rpsA = parseLocaleNumber(document.getElementById("rpsA").value || 0);
  const rpsB = parseLocaleNumber(document.getElementById("rpsB").value || 0);
  const rpsDiff = (Number.isFinite(rpsA) && Number.isFinite(rpsB)) ? (rpsB - rpsA) : NaN;

  const cur = document.getElementById("currency").value;
  const estRevenue = rpsDiff * nB;

  const lastYearSessions = Number(document.getElementById("lastYearSessions").value || 0);
  const lastYearRev = rpsDiff * lastYearSessions;

  const significant = (pValue < alpha);

  function setVal(id, text){
    const el = document.getElementById(id);
    el.textContent = text;
    el.classList.remove("waiting");
  }

  setVal("crA", fmtPct(pA, 2));
  setVal("crB", fmtPct(pB, 2));
  setVal("uplift", pA === 0 ? "—" : ((pB-pA)/pA*100).toFixed(2) + "%");
  setVal("diffpp", (delta*100).toFixed(3) + " pp");

  setVal("seA", fmtNum(seA, 6));
  setVal("seB", fmtNum(seB, 6));
  setVal("seDiff", fmtNum(seDiff, 6));
  setVal("z", fmtNum(z, 4));

  setVal("p", fmtNum(pValue, 4));
  setVal("cl", (CL*100).toFixed(2) + "%");
  setVal("power", (power*100).toFixed(2) + "%");

  // 5) Decision styling logic
  const sigEl = document.getElementById("sig");
  sigEl.textContent = significant ? "Significant" : "Not significant";
  sigEl.classList.remove("waiting","decision-good","decision-bad");
  sigEl.classList.add(significant ? "decision-good" : "decision-bad");

  setVal("curOut", cur);
  setVal("rpsDiff", Number.isFinite(rpsDiff) ? rpsDiff.toFixed(4) : "—");

  setVal("estRev", Number.isFinite(estRevenue) ? `${fmtMoney(estRevenue)} ${cur}` : "—");
  setVal("lastYearRev", Number.isFinite(lastYearRev) ? `${fmtMoney(lastYearRev)} ${cur} (approx)` : "—");
}

/* init */
setCurrencyFromMarket();
setAllWaiting();

// live updates
["nA","nB","xA","xB","cvrA","cvrB","rpsA","rpsB","lastYearSessions"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener("input", clearResultsIfEmpty);
});
</script>
</body>
</html>
